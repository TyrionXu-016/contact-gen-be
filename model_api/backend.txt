import requests
import json
import os # 用于获取环境变量，例如AI服务的URL

# 我的FastAPI AI服务运行http://localhost:8000
AI_SERVICE_BASE_URL = os.getenv("AI_SERVICE_BASE_URL", "http://localhost:8000")

def call_ai_service_to_generate_contract(prompt: str, contract_type: str = None, cooperation_purpose: str = None) -> str:
    """
    在 Django 后端中调用 FastAPI AI 服务来生成合同。
    """
    endpoint = f"{AI_SERVICE_BASE_URL}/generate-contract"
    
    # 构造请求体 (FastAPI 的 /generate-contract 期望的是 POST 请求和 JSON body)
    payload = {
        "prompt": prompt,
        "contract_type": contract_type,
        "max_new_tokens": 5000, # 最大输出token数，可以从配置中读取或由前端传递，这个是用来自己测试的，不用暴露给用户
        "temperature": 0.7,# 生成词汇的采样参数，可以从配置中读取或由前端传递，这个是用来自己测试的，不用暴露给用户
        "use_knowledge_base": True# 是否使用向量知识库，可以从配置中读取或由前端传递，这个是用来自己测试的，不用暴露给用户
    }

    try:
        # 发送 POST 请求
        response = requests.post(endpoint, json=payload, stream=True)
        response.raise_for_status() # 如果状态码不是200，则抛出异常

        generated_text_chunks = []
        for chunk in response.iter_content(chunk_size=None, decode_unicode=True):
            if chunk: # 过滤掉空的 chunk
                generated_text_chunks.append(chunk)
        
        return "".join(generated_text_chunks)

    except requests.exceptions.RequestException as e:
        print(f"Error calling AI service: {e}")
        # 根据实际情况处理错误，例如返回默认值或抛出自定义异常
        return f"调用AI服务失败: {e}"
    except json.JSONDecodeError as e:
        print(f"Error decoding JSON response from AI service: {e}")
        return f"AI服务响应格式错误: {e}"

# 假设在你的Django视图或某个服务层中调用
# example_prompt = "请生成一份关于采购XXX设备的买卖合同。"
# example_contract_type = "买卖合同"
# example_cooperation_purpose = "设备采购"
# generated_contract = call_ai_service_to_generate_contract(example_prompt, example_contract_type, example_cooperation_purpose)
# print(generated_contract)